---
title: "Scotland Reforestation"
author: "Louis Goodall"
date: "2024-12-16"
output: pdf_document
---

```{r}
x <- readxl::read_xlsx("~/Downloads/nsf24321-tab001.xlsx") %>%
  `colnames<-`(c("FiscalYear", "Total", "Total_RD", "TotalResearch", "BasicResearch", "AppliedResearch", "Development", "RDPlant"))

x <- x %>%
  pivot_longer(cols = c("BasicResearch", "AppliedResearch"), names_to = "Variable", values_to = "Value")


ggplot(x, aes(x = FiscalYear, y = Value, col = Variable, group = Variable)) +
  geom_line() +
  theme_classic()
```





```{r, message = FALSE, warning = FALSE}
library(tidyverse)
library(terra)
library(sf)
library(spatialEco)
library(ncdf4)
library(rgbif)
library(ellipse)
library(tsne)
library(tidyterra)
library(SPEI)
library(ggspatial)
library(rnaturalearth)
library(spdep)
library(ggpointdensity)
library(spgwr)
library(tmap)
library(landscapemetrics)
library(patchwork)
options(scipen = 999)
options(digits = 7)
templateRaster <- rast("/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Rasters/scotlandDEM100m.tif")
```


```{r}
# Read in 30m DEM raster and then crop and mask it to the Caledonian shapefile
scotlandDEM <- rast("/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/scotland30mDEM.tif") %>%
  project("epsg:32630", res = c(100,100))
pinewoodShp <- st_read("/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Pinewood Shapefile/FGS_Eligibility_Pinewood_Zone.shp") %>%
  st_transform(crs = crs(scotlandDEM))
scotlandDEM <- crop(scotlandDEM, ext(pinewoodShp))
scotlandDEM <- mask(scotlandDEM, pinewoodShp)
# plot(scotlandDEM)
# writeRaster(scotlandDEM, "/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Rasters/scotlandDEM100m.tif", overwrite = TRUE)

# Read in landcover data and filter out urban areas and anything resembling
# a bog/fen/wetland etc.
scotLULC <- rast("/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Land Cover/HLCM_2019.tif")
templateLULC <- pinewoodShp %>% st_transform(crs = crs(scotLULC))
scotLULC <- crop(scotLULC, templateLULC)
scotLULC <- mask(scotLULC, templateLULC)
scotLULC <- project(scotLULC, scotlandDEM)

# Create a template raster to be used to filter out the bog and urban areas
dropRast <- ifel(scotLULC$EUNIS_CODE == "D1", NA,
                 ifel(scotLULC$EUNIS_CODE == "D2", NA,
                      ifel(scotLULC$EUNIS_CODE == "D4", NA,
                           ifel(scotLULC$EUNIS_CODE == "J", NA,
                                ifel(scotLULC$EUNIS_CODE == "H2", NA,
                                     ifel(scotLULC$EUNIS_CODE == "H3", NA,
                                          ifel(scotLULC$EUNIS_CODE == "C", NA,
                                               ifel(scotLULC$EUNIS_CODE == "A2", NA,
                                                    ifel(scotLULC$EUNIS_CODE == "B1", NA,
                                                         ifel(scotLULC$EUNIS_CODE == "B2", NA,
                                                              ifel(scotLULC$EUNIS_CODE == "B3", NA, scotLULC$EUNIS_CODE)))))))))))

#----TOPOGRAPHICAL FEATURES----#
slope <- terra::terrain(scotlandDEM, v = "slope", neighbors = 8, unit = "degrees")
aspect <- terra::terrain(scotlandDEM, v = "aspect", neighbors = 8, unit = "degrees")
# Reclassify aspect raster into categorical cardinal directions
aspect <- aspect %% 360
breaks <- c(0, 22.5, 67.5, 112.5, 157.5, 202.5, 247.5, 292.5, 337.5, 360)
aspect <- terra::classify(aspect, breaks, include.lowest = TRUE)
labels <- c("NE", "E", "SE", "S", "SW", "W", "NW", "N")
slope <- mask(slope, dropRast)
aspect <- mask(aspect, dropRast)
writeRaster(slope, "/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Rasters/slope.tif", overwrite = TRUE)
writeRaster(aspect, "/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Rasters/aspect.tif", overwrite = TRUE)

#----CLIMATE DATA----#
##--MEAN CLIMATE DATA--##
# Create a bounding box for cropping the rasters
scotlandBBox <- ext(1e+05, 4.5e+05, 6.5e+05, 1000000)
raster_directory <- "/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Climate/tas"
raster_files <- list.files(path = raster_directory, pattern = ".nc", full.names = TRUE)
raster_list <- list()
for (file in raster_files) {
  raster_obj <- rast(file)
  raster_list[[file]] <- raster_obj
}
# Crop the rasters
cropped_raster_list <- list()
for (i in seq_along(raster_list)) {
  cropped_raster <- crop(raster_list[[i]], scotlandBBox)
  cropped_raster_list[[i]] <- cropped_raster
}
# Reproject the rasters
# target_crs <- crs(scotlandDEM)
reprojected_rasters <- list()
# Loop through each raster object
for (raster in cropped_raster_list) {
  # Reproject the raster and add it to the list
  reprojected_raster <- project(raster, scotlandDEM)
  reprojected_rasters <- c(reprojected_rasters, list(reprojected_raster))
}
# Crop the mean temperature rasters and then mask them
cropped_rasters <- list()
for (raster in reprojected_rasters) {
  cropped_raster <- crop(raster, ext(pinewoodShp))
  cropped_rasters <- c(cropped_rasters, list(cropped_raster))
}
masked_rasters <- list()
for (raster in cropped_rasters) {
  masked_raster <- mask(raster, pinewoodShp)
  masked_rasters <- c(masked_rasters, list(masked_raster))
}
# Calculate continentality index for each year and then find the mean across all year
rast2013 <- masked_rasters[[1]][[7]] - masked_rasters[[1]][[2]]
rast2014 <- masked_rasters[[2]][[7]] - masked_rasters[[2]][[12]]
rast2015 <- masked_rasters[[3]][[8]] - masked_rasters[[3]][[1]]
rast2016 <- masked_rasters[[4]][[8]] - masked_rasters[[4]][[2]]
rast2017 <- masked_rasters[[5]][[8]] - masked_rasters[[5]][[2]]
rast2018 <- masked_rasters[[6]][[7]] - masked_rasters[[6]][[1]]
rast2019 <- masked_rasters[[7]][[7]] - masked_rasters[[7]][[3]]
rast2020 <- masked_rasters[[8]][[8]] - masked_rasters[[8]][[1]]
rast2021 <- masked_rasters[[9]][[7]] - masked_rasters[[9]][[3]]
rast2022 <- masked_rasters[[10]][[7]] - masked_rasters[[10]][[2]]
continentalStack <- raster::stack(c(rast2013,rast2014,rast2015,rast2016,rast2017,rast2018,rast2019,rast2020,rast2021,rast2022))
rm(rast2013,rast2014,rast2015,rast2016,rast2017,rast2018,rast2019,rast2020,rast2021,rast2022)
continentalRast <- rast(raster::calc(continentalStack, mean))
continentalRast <- mask(continentalRast, dropRast)
rm(continentalStack)
writeRaster(continentalRast, "/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Rasters/continentalRaster.tif", overwrite = TRUE)

#--MIN TEMP DATA--##
raster_directory <- "/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Climate/tasmin"
raster_files <- list.files(path = raster_directory, pattern = ".nc", full.names = TRUE)
raster_list <- list()
for (file in raster_files) {
  raster_obj <- rast(file)
  raster_list[[file]] <- raster_obj
}
# Crop the rasters
cropped_raster_list <- list()
for (i in seq_along(raster_list)) {
  cropped_raster <- crop(raster_list[[i]], scotlandBBox)
  cropped_raster_list[[i]] <- cropped_raster
}
# Reproject the rasters
target_crs <- crs(scotlandDEM)
reprojected_rasters <- list()
# Loop through each raster object
for (raster in cropped_raster_list) {
  # Reproject the raster and add it to the list
  reprojected_raster <- project(raster, scotlandDEM)
  reprojected_rasters <- c(reprojected_rasters, list(reprojected_raster))
}
# Crop the mean temperature rasters and then mask them
cropped_rasters <- list()
for (raster in reprojected_rasters) {
  cropped_raster <- crop(raster, ext(pinewoodShp))
  cropped_rasters <- c(cropped_rasters, list(cropped_raster))
}
masked_rasters <- list()
for (raster in cropped_rasters) {
  masked_raster <- mask(raster, pinewoodShp)
  masked_rasters <- c(masked_rasters, list(masked_raster))
}
rast2013 <- raster::stack(masked_rasters[[1]])
rast2013 <- raster::calc(rast2013, mean)
rast2014 <- raster::stack(masked_rasters[[2]])
rast2014 <- raster::calc(rast2014, mean)
rast2015 <- raster::stack(masked_rasters[[3]])
rast2015 <- raster::calc(rast2015, mean)
rast2016 <- raster::stack(masked_rasters[[4]])
rast2016 <- raster::calc(rast2016, mean)
rast2017 <- raster::stack(masked_rasters[[5]])
rast2017 <- raster::calc(rast2017, mean)
rast2018 <- raster::stack(masked_rasters[[6]])
rast2018 <- raster::calc(rast2018, mean)
rast2019 <- raster::stack(masked_rasters[[7]])
rast2019 <- raster::calc(rast2019, mean)
rast2020 <- raster::stack(masked_rasters[[8]])
rast2020 <- raster::calc(rast2020, mean)
rast2021 <- raster::stack(masked_rasters[[9]])
rast2021 <- raster::calc(rast2021, mean)
rast2022 <- raster::stack(masked_rasters[[10]])
rast2022 <- raster::calc(rast2022, mean)
tempMinRast <- raster::stack(rast2013,rast2014,rast2015,rast2016,rast2017,rast2018,rast2019,rast2020,rast2021,rast2022)
rm(rast2013,rast2014,rast2015,rast2016,rast2017,rast2018,rast2019,rast2020,rast2021,rast2022)
tempMinRast <- raster::calc(tempMinRast, mean)
tempMinRast <- rast(tempMinRast)
tempMinRast <- mask(tempMinRast, dropRast)
writeRaster(tempMinRast, "/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Rasters/tempMinRaster.tif", overwrite = TRUE)

#--MAX TEMP DATA--##
raster_directory <- "/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Climate/tasmax"
raster_files <- list.files(path = raster_directory, pattern = ".nc", full.names = TRUE)
raster_list <- list()
for (file in raster_files) {
  raster_obj <- rast(file)
  raster_list[[file]] <- raster_obj
}
# Crop the rasters
cropped_raster_list <- list()
for (i in seq_along(raster_list)) {
  cropped_raster <- crop(raster_list[[i]], scotlandBBox)
  cropped_raster_list[[i]] <- cropped_raster
}
# Reproject the rasters
target_crs <- crs(scotlandDEM)
reprojected_rasters <- list()
# Loop through each raster object
for (raster in cropped_raster_list) {
  # Reproject the raster and add it to the list
  reprojected_raster <- project(raster, scotlandDEM)
  reprojected_rasters <- c(reprojected_rasters, list(reprojected_raster))
}
# Crop the mean temperature rasters and then mask them
cropped_rasters <- list()
for (raster in reprojected_rasters) {
  cropped_raster <- crop(raster, ext(pinewoodShp))
  cropped_rasters <- c(cropped_rasters, list(cropped_raster))
}
masked_rasters <- list()
for (raster in cropped_rasters) {
  masked_raster <- mask(raster, pinewoodShp)
  masked_rasters <- c(masked_rasters, list(masked_raster))
}
rast2013 <- raster::stack(masked_rasters[[1]])
rast2013 <- raster::calc(rast2013, mean)
rast2014 <- raster::stack(masked_rasters[[2]])
rast2014 <- raster::calc(rast2014, mean)
rast2015 <- raster::stack(masked_rasters[[3]])
rast2015 <- raster::calc(rast2015, mean)
rast2016 <- raster::stack(masked_rasters[[4]])
rast2016 <- raster::calc(rast2016, mean)
rast2017 <- raster::stack(masked_rasters[[5]])
rast2017 <- raster::calc(rast2017, mean)
rast2018 <- raster::stack(masked_rasters[[6]])
rast2018 <- raster::calc(rast2018, mean)
rast2019 <- raster::stack(masked_rasters[[7]])
rast2019 <- raster::calc(rast2019, mean)
rast2020 <- raster::stack(masked_rasters[[8]])
rast2020 <- raster::calc(rast2020, mean)
rast2021 <- raster::stack(masked_rasters[[9]])
rast2021 <- raster::calc(rast2021, mean)
rast2022 <- raster::stack(masked_rasters[[10]])
rast2022 <- raster::calc(rast2022, mean)
tempMaxRast <- raster::stack(rast2013,rast2014,rast2015,rast2016,rast2017,rast2018,rast2019,rast2020,rast2021,rast2022)
rm(rast2013,rast2014,rast2015,rast2016,rast2017,rast2018,rast2019,rast2020,rast2021,rast2022)
tempMaxRast <- raster::calc(tempMaxRast, mean)
tempMaxRast <- rast(tempMaxRast)
tempMaxRast <- mask(tempMaxRast, dropRast)
writeRaster(tempMaxRast, "/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Rasters/tempMaxRaster.tif", overwrite = TRUE)

#--RAINFALL DATA--##
raster_directory <- "/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Climate/rainfall"
raster_files <- list.files(path = raster_directory, pattern = ".nc", full.names = TRUE)
raster_list <- list()
for (file in raster_files) {
  raster_obj <- rast(file)
  raster_list[[file]] <- raster_obj
}
# Crop the rasters
cropped_raster_list <- list()
for (i in seq_along(raster_list)) {
  cropped_raster <- crop(raster_list[[i]], scotlandBBox)
  cropped_raster_list[[i]] <- cropped_raster
}
# Reproject the rasters
target_crs <- crs(scotlandDEM)
reprojected_rasters <- list()
# Loop through each raster object
for (raster in cropped_raster_list) {
  # Reproject the raster and add it to the list
  reprojected_raster <- project(raster, scotlandDEM)
  reprojected_rasters <- c(reprojected_rasters, list(reprojected_raster))
}
# Crop the mean temperature rasters and then mask them
cropped_rasters <- list()
for (raster in reprojected_rasters) {
  cropped_raster <- crop(raster, ext(pinewoodShp))
  cropped_rasters <- c(cropped_rasters, list(cropped_raster))
}
masked_rasters <- list()
for (raster in cropped_rasters) {
  masked_raster <- mask(raster, pinewoodShp)
  masked_rasters <- c(masked_rasters, list(masked_raster))
}
rast2013 <- raster::stack(masked_rasters[[1]])
rast2013 <- raster::calc(rast2013, sum)
rast2014 <- raster::stack(masked_rasters[[2]])
rast2014 <- raster::calc(rast2014, sum)
rast2015 <- raster::stack(masked_rasters[[3]])
rast2015 <- raster::calc(rast2015, sum)
rast2016 <- raster::stack(masked_rasters[[4]])
rast2016 <- raster::calc(rast2016, sum)
rast2017 <- raster::stack(masked_rasters[[5]])
rast2017 <- raster::calc(rast2017, sum)
rast2018 <- raster::stack(masked_rasters[[6]])
rast2018 <- raster::calc(rast2018, sum)
rast2019 <- raster::stack(masked_rasters[[7]])
rast2019 <- raster::calc(rast2019, sum)
rast2020 <- raster::stack(masked_rasters[[8]])
rast2020 <- raster::calc(rast2020, sum)
rast2021 <- raster::stack(masked_rasters[[9]])
rast2021 <- raster::calc(rast2021, sum)
rast2022 <- raster::stack(masked_rasters[[10]])
rast2022 <- raster::calc(rast2022, sum)
rainfallRast <- raster::stack(rast2013,rast2014,rast2015,rast2016,rast2017,rast2018,rast2019,rast2020,rast2021,rast2022)
rm(rast2013,rast2014,rast2015,rast2016,rast2017,rast2018,rast2019,rast2020,rast2021,rast2022)
rainfallRast <- raster::calc(rainfallRast, mean)
rainfallRast <- rast(rainfallRast)
rainfallRast <- mask(rainfallRast, dropRast)
writeRaster(rainfallRast, "/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Rasters/rainfallRaster.tif", overwrite = TRUE)

#--SUNLIGHT--##
raster_directory <- "/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Climate/sun"
raster_files <- list.files(path = raster_directory, pattern = ".nc", full.names = TRUE)
raster_list <- list()
for (file in raster_files) {
  raster_obj <- rast(file)
  raster_list[[file]] <- raster_obj
}
# Crop the rasters
cropped_raster_list <- list()
for (i in seq_along(raster_list)) {
  cropped_raster <- crop(raster_list[[i]], scotlandBBox)
  cropped_raster_list[[i]] <- cropped_raster
}
# Reproject the rasters
target_crs <- crs(scotlandDEM)
reprojected_rasters <- list()
# Loop through each raster object
for (raster in cropped_raster_list) {
  # Reproject the raster and add it to the list
  reprojected_raster <- project(raster, scotlandDEM)
  reprojected_rasters <- c(reprojected_rasters, list(reprojected_raster))
}
# Crop the mean temperature rasters and then mask them
cropped_rasters <- list()
for (raster in reprojected_rasters) {
  cropped_raster <- crop(raster, ext(pinewoodShp))
  cropped_rasters <- c(cropped_rasters, list(cropped_raster))
}
masked_rasters <- list()
for (raster in cropped_rasters) {
  masked_raster <- mask(raster, pinewoodShp)
  masked_rasters <- c(masked_rasters, list(masked_raster))
}
rast2013 <- raster::stack(masked_rasters[[1]])
rast2013 <- raster::calc(rast2013, sum)
rast2014 <- raster::stack(masked_rasters[[2]])
rast2014 <- raster::calc(rast2014, sum)
rast2015 <- raster::stack(masked_rasters[[3]])
rast2015 <- raster::calc(rast2015, sum)
rast2016 <- raster::stack(masked_rasters[[4]])
rast2016 <- raster::calc(rast2016, sum)
rast2017 <- raster::stack(masked_rasters[[5]])
rast2017 <- raster::calc(rast2017, sum)
rast2018 <- raster::stack(masked_rasters[[6]])
rast2018 <- raster::calc(rast2018, sum)
rast2019 <- raster::stack(masked_rasters[[7]])
rast2019 <- raster::calc(rast2019, sum)
rast2020 <- raster::stack(masked_rasters[[8]])
rast2020 <- raster::calc(rast2020, sum)
rast2021 <- raster::stack(masked_rasters[[9]])
rast2021 <- raster::calc(rast2021, sum)
rast2022 <- raster::stack(masked_rasters[[10]])
rast2022 <- raster::calc(rast2022, sum)
sunRast <- raster::stack(rast2013,rast2014,rast2015,rast2016,rast2017,rast2018,rast2019,rast2020,rast2021,rast2022)
rm(rast2013,rast2014,rast2015,rast2016,rast2017,rast2018,rast2019,rast2020,rast2021,rast2022)
sunRast <- raster::calc(sunRast, mean)
sunRast <- rast(sunRast)
sunRast <- mask(sunRast, dropRast)
writeRaster(sunRast, "/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Rasters/sunRaster.tif", overwrite = TRUE)

#----SOIL DRAINAGE----#
sf_use_s2(FALSE) # use this command otherwise the shapefile merge will not work
soilDrainage <- st_read("/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Soils/AWC_2019_1.shp") %>%
  st_transform(crs = crs(scotlandDEM)) %>%
  st_intersection(.,pinewoodShp[2])
# Rasterise the shapefile
soilDrainRast <- rasterize(soilDrainage[2], scotlandDEM, field = "AWC")
soilDrainRast <- mask(soilDrainRast, dropRast)
writeRaster(soilDrainRast, "/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Rasters/soilDrainage.tif", overwrite = TRUE)

# Also make the all SpatRasters (terra)
scotRasters <- list(rainfallRast, tempMaxRast, tempMinRast, sunRast, continentalRast, aspect, slope, soilDrainRast, scotlandDEM)

```


```{r}
#----PINE LOCATIONS----#
pineData <- st_read("/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Scots Pine Inventory/Caledonian_Pinewood_Inventory.shp") %>%
  st_transform(crs = crs(scotlandDEM))
# Create Pinewood area, made up of natural pinewood and regeneration area and then rasterise
pineWoodDf <- pineData %>%
  filter(FEATDESC == "Cal Pine Regeneration Zone" | FEATDESC == "Caledonian Pinewood")
pineRast <- terra::rasterize(pineWoodDf[3], scotlandDEM, field = "FEATDESC")
pineRast <- project(pineRast, scotlandDEM)
pineRast <- mask(pineRast, dropRast)
writeRaster(pineRast, "/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Rasters/pinewoodRaster.tif", overwrite = TRUE)

#----OAK LOCATIONS----#
oakShp <- st_read("/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Native_Woodland_Survey_of_Scotland/Native_Woodland_Survey_of_Scotland.shp") %>%
  st_transform(crs = crs(scotlandDEM)) %>%
  filter(grepl("oak", DOM_HABITA))
oakRast <- rasterize(oakShp, scotlandDEM, field = "DOM_HABITA")
oakRast <- mask(oakRast, scotlandDEM)
oakRast <- mask(oakRast, dropRast)

#----BIRCH LOCATIONS----#
birchShp <- st_read("/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Native_Woodland_Survey_of_Scotland/Native_Woodland_Survey_of_Scotland.shp") %>%
  st_transform(crs = crs(scotlandDEM)) %>%
  filter(grepl("birch", DOM_HABITA),
         MATURITY == "Mature" | MATURITY == "Regenerating")
birchRast <- rasterize(birchShp, scotlandDEM, field = "DOM_HABITA")
birchRast <- mask(birchRast, scotlandDEM)
birchRast <- mask(birchRast, dropRast)
```


# Scenario creation

```{r}
scotLULC <- rast("/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Land Cover/HLCM_2020.tif")

templateRaster <- rast("/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Rasters/scotlandDEM100m.tif")
pinewoodShp <- st_read("/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Pinewood Shapefile/FGS_Eligibility_Pinewood_Zone.shp") %>%
  st_transform(crs = crs(templateRaster))

scotLULC <- project(scotLULC, templateRaster)
scotLULC <- mask(scotLULC, pinewoodShp)

scotCoverType <- scotLULC$EUNIS_CODE %>% as.data.frame() %>% unique() %>% arrange(EUNIS_CODE) %>%
  mutate(CoverType = ifelse(.$EUNIS_CODE == "C", "Water",
                            ifelse(.$EUNIS_CODE %in% c("D1","D2","D4"), "Wetland",
                                   ifelse(.$EUNIS_CODE %in% c("E1","E2","E3","E4","E5"), "Grasslands",
                                          ifelse(.$EUNIS_CODE %in% c("F2","F3","F4","F9"), "Heathland/Scrub",
                                                 ifelse(.$EUNIS_CODE %in% c("H2","H3"), "Rock",
                                                        ifelse(.$EUNIS_CODE == "I1", "Arable",
                                                               ifelse(.$EUNIS_CODE == "G1", "Broadleaved Woodland",
                                                                      ifelse(.$EUNIS_CODE == "G3", "Scots Pine",
                                                                             ifelse(.$EUNIS_CODE == "G4", "Mixed Woodland",
                                                                                    ifelse(.$EUNIS_CODE == "G5", "Small Woodland",
                                                                                           ifelse(.$EUNIS_CODE == "J", "Urban",
                                                                                                  ifelse(.$EUNIS_CODE == "O", "Bare Field", .$EUNIS_CODE)))))))))))))

scotLULCDf <- as.data.frame(scotLULC, xy = TRUE)
scotLULCDf <- scotLULCDf %>% left_join(scotCoverType, by = "EUNIS_CODE")
scotLULC <- as_spatraster(scotLULCDf[,c(1,2,4)])
crs(scotLULC) <- crs(templateRaster)

forestCoverLULC <- ifel(scotLULC$CoverType == "Arable", NA,
     ifel(scotLULC$CoverType == "Bare Field", NA,
          ifel(scotLULC$CoverType == "Grasslands", NA,
               ifel(scotLULC$CoverType == "Heathland/Scrub", NA,
                    ifel(scotLULC$CoverType == "Rock", NA,
                         ifel(scotLULC$CoverType == "Urban", NA,
                              ifel(scotLULC$CoverType == "Water", NA,
                                   ifel(scotLULC$CoverType == "Wetland", NA, 1))))))))

# plot(forestCoverLULC)
# plot(scotNP[3], add = TRUE, col = NA)


scotALC <- st_read("/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Forest ALC/lcf250k_dleas.shp")
scotALC <- scotALC %>% st_transform(crs = "EPSG:32630")
scotALC <- scotALC %>% st_crop(pinewoodShp)
scotALC <- scotALC %>% st_intersection(pinewoodShp)
scotALCRast <- rasterize(scotALC, templateRaster, field = "LAND_CLASS")

scotNP <- st_read("/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Scotland NP/National_Parks_-_Scotland.shp") %>% st_transform(crs = crs(scotALCRast))

# < 600m elevation and NP to be removed
mask650 <- ifel(scotlandDEM > 650, 1, NA)
mask <- rasterize(scotNP, templateRaster, field = "name")

# Restrictive scenario 1 (most restrictions)
# 1 == Land that isn't suitable for planting
restrictiveScenario1 <- ifel(scotALCRast$LAND_CLASS == "Limited flexibility for trees", 1,
     ifel(scotALCRast$LAND_CLASS == "Very limited flexibility for trees", 1,
          ifel(scotALCRast$LAND_CLASS == "Land unsuitable for trees", 1,
               ifel(scotALCRast$LAND_CLASS == "Water", 1,
                    ifel(scotALCRast$LAND_CLASS == "Built up area", 1, NA)))))
# plot(restrictiveScenario1)
rastCollection <- terra::sprc(restrictiveScenario1, forestCoverLULC)
restrictiveScenario1 <- terra::merge(rastCollection[1], rastCollection[2], mask650)
restrictiveScenario1[!is.na(mask)] <- 1
plot(restrictiveScenario1)
plot(scotNP[2], add = TRUE, col = NA)

# Restrictive scenario 2 (high restrictions)
restrictiveScenario2 <- ifel(scotALCRast$LAND_CLASS == "Very limited flexibility for trees", 1,
     ifel(scotALCRast$LAND_CLASS == "Land unsuitable for trees", 1,
          ifel(scotALCRast$LAND_CLASS == "Water", 1,
               ifel(scotALCRast$LAND_CLASS == "Built up area", 1, NA))))
# plot(restrictiveScenario2)
rastCollection <- terra::sprc(restrictiveScenario2, forestCoverLULC)
restrictiveScenario2 <- terra::merge(rastCollection[1], rastCollection[2], mask650)
restrictiveScenario2[!is.na(mask)] <- 1
plot(restrictiveScenario2)
plot(scotNP[2], add = TRUE, col = NA)

# Restrictive scenario 3 (moderate restrictions)
restrictiveScenario3 <- ifel(scotALCRast$LAND_CLASS == "Land unsuitable for trees", 1, 
                             ifel(scotALCRast$LAND_CLASS == "Water", 1,
               ifel(scotALCRast$LAND_CLASS == "Built up area", 1, NA)))
# plot(restrictiveScenario3)
rastCollection <- terra::sprc(restrictiveScenario3, forestCoverLULC)
restrictiveScenario3 <- terra::merge(rastCollection[1], rastCollection[2], mask650)
restrictiveScenario3[!is.na(mask)] <- 1
plot(restrictiveScenario3)
plot(scotNP[2], add = TRUE, col = NA)

# restrictive scenario 4 (least restrictions)
restrictiveScenario4 <- ifel(scotALCRast$LAND_CLASS == "Land unsuitable for trees", 1, 
                             ifel(scotALCRast$LAND_CLASS == "Water", 1,
               ifel(scotALCRast$LAND_CLASS == "Built up area", 1, NA)))
rastCollection <- terra::sprc(restrictiveScenario4, forestCoverLULC)
restrictiveScenario4 <- terra::merge(rastCollection[1], rastCollection[2], mask650)
plot(restrictiveScenario4)
plot(scotNP[2], add = TRUE, col = NA)

################################
######## DELETE LATER ##########
################################
aspect <- rast("/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Rasters/aspect.tif")
continentalRast <- rast("/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Rasters/continentalRaster.tif")
pineRast <- rast("/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Rasters/pinewoodRaster.tif")
rainfallRast <- rast("/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Rasters/rainfallRaster.tif")
scotlandDEM <- rast("/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Rasters/scotlandDEM100m.tif")
slope <- rast("/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Rasters/slope.tif")
soilDrainRast <- rast("/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Rasters/soilDrainage.tif")
sunRast <- rast("/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Rasters/sunRaster.tif")
tempMinRast <- rast("/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Rasters/tempMinRaster.tif")
tempMaxRast <- rast("/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Rasters/tempMaxRaster.tif")
################################


# Make dataframes out of the scenarios
# Scenario 1 dataframe

# rasterList <- list(aspect, slope, continentalRast, tempMaxRast, rainfallRast, sunRast, soilDrainRast, scotlandDEM)
# rs1List <- lapply(rasterList, function(x){crop(x, restrictiveScenario1)})
# rs1List <- lapply(rs1List, function(x){mask(x, restrictiveScenario1, maskvalue = 1)})
# rasterListConverted <- lapply(rs1List, function(x){raster::raster(x)})
# rasterStack <- raster::stack(rasterListConverted)
# xy <- xyFromCell(rasterStack, 1:ncell(rasterStack))
# result_df <- data.frame(x = xy[,1], y = xy[,2])
# for (i in 1:raster::nlayers(rasterStack)) {
#   layer_values <- extract(rasterStack[[i]], xy)
#   result_df[paste0("layer", i)] <- layer_values
# }
# restrictiveScenario1Df <- result_df %>% drop_na()
# names(restrictiveScenario1Df) <- c("x", "y", "Aspect", "Slope", "Continentality_Index", "Max_Temp", "Total_Rainfall", "Total_Sunlight_Hours", "Soil_Drainage", "Elevation")
# restrictiveScenario1Df <- restrictiveScenario1Df[,c("x", "y", "Total_Rainfall", "Max_Temp", "Total_Sunlight_Hours", "Continentality_Index", "Aspect", "Slope", "Soil_Drainage", "Elevation")]

rasterList <- list(aspect, slope, continentalRast, tempMaxRast, rainfallRast, sunRast, soilDrainRast, scotlandDEM)
rs1List <- lapply(rasterList, function(x){crop(x, restrictiveScenario1)})
rs1List <- lapply(rs1List, function(x){mask(x, restrictiveScenario1, maskvalue = 1)})
rasterStack <- rast(rs1List)
result_df <- as.data.frame(rasterStack, xy = TRUE) %>% drop_na()
names(result_df) <- c("x", "y", "Aspect","Slope","Continentality_Index","Max_Temp","Total_Rainfall","Total_Sunlight_Hours", "Soil_Drainage","Elevation")
restrictiveScenario1Df <- result_df[,c("x","y","Total_Rainfall","Max_Temp","Total_Sunlight_Hours","Continentality_Index","Aspect","Slope","Soil_Drainage","Elevation")]


# Scenario 2 dataframe
rasterList <- list(aspect, slope, continentalRast, tempMaxRast, rainfallRast, sunRast, soilDrainRast, scotlandDEM)
rs2List <- lapply(rasterList, function(x){crop(x, restrictiveScenario2)})
rs2List <- lapply(rs2List, function(x){mask(x, restrictiveScenario2, maskvalue = 1)})
rasterStack <- rast(rs2List)
result_df <- as.data.frame(rasterStack, xy = TRUE) %>% drop_na()
names(result_df) <- c("x", "y", "Aspect","Slope","Continentality_Index","Max_Temp","Total_Rainfall","Total_Sunlight_Hours", "Soil_Drainage","Elevation")
restrictiveScenario2Df <- result_df[,c("x","y","Total_Rainfall","Max_Temp","Total_Sunlight_Hours","Continentality_Index","Aspect","Slope","Soil_Drainage","Elevation")]

# Scenario 3 dataframe
rasterList <- list(aspect, slope, continentalRast, tempMaxRast, rainfallRast, sunRast, soilDrainRast, scotlandDEM)
rs3List <- lapply(rasterList, function(x){crop(x, restrictiveScenario3)})
rs3List <- lapply(rs3List, function(x){mask(x, restrictiveScenario3, maskvalue = 1)})
rasterStack <- rast(rs3List)
result_df <- as.data.frame(rasterStack, xy = TRUE) %>% drop_na()
names(result_df) <- c("x", "y", "Aspect","Slope","Continentality_Index","Max_Temp","Total_Rainfall","Total_Sunlight_Hours", "Soil_Drainage","Elevation")
restrictiveScenario3Df <- result_df[,c("x","y","Total_Rainfall","Max_Temp","Total_Sunlight_Hours","Continentality_Index","Aspect","Slope","Soil_Drainage","Elevation")]

# Scenario 4 dataframe
rasterList <- list(aspect, slope, continentalRast, tempMaxRast, rainfallRast, sunRast, soilDrainRast, scotlandDEM)
rs4List <- lapply(rasterList, function(x){crop(x, restrictiveScenario4)})
rs4List <- lapply(rs4List, function(x){mask(x, restrictiveScenario4, maskvalue = 1)})
rasterStack <- rast(rs4List)
result_df <- as.data.frame(rasterStack, xy = TRUE) %>% drop_na()
names(result_df) <- c("x", "y", "Aspect","Slope","Continentality_Index","Max_Temp","Total_Rainfall","Total_Sunlight_Hours", "Soil_Drainage","Elevation")
restrictiveScenario4Df <- result_df[,c("x","y","Total_Rainfall","Max_Temp","Total_Sunlight_Hours","Continentality_Index","Aspect","Slope","Soil_Drainage","Elevation")]


restrictiveScenario1Df$Aspect <- as.numeric(restrictiveScenario1Df$Aspect)
restrictiveScenario1Df <- restrictiveScenario1Df %>% mutate(Aspect = ifelse(Aspect == 9, 1, Aspect))

restrictiveScenario2Df$Aspect <- as.numeric(restrictiveScenario2Df$Aspect)
restrictiveScenario2Df <- restrictiveScenario2Df %>% mutate(Aspect = ifelse(Aspect == 9, 1, Aspect))

restrictiveScenario3Df$Aspect <- as.numeric(restrictiveScenario3Df$Aspect)
restrictiveScenario3Df <- restrictiveScenario3Df %>% mutate(Aspect = ifelse(Aspect == 9, 1, Aspect))

restrictiveScenario4Df$Aspect <- as.numeric(restrictiveScenario4Df$Aspect)
restrictiveScenario4Df <- restrictiveScenario4Df %>% mutate(Aspect = ifelse(Aspect == 9, 1, Aspect))

scaleScenario1 <- as.data.frame(scale(restrictiveScenario1Df[,-c(1,2)]))
scaleScenario2 <- as.data.frame(scale(restrictiveScenario2Df[,-c(1,2)]))
scaleScenario3 <- as.data.frame(scale(restrictiveScenario3Df[,-c(1,2)]))
scaleScenario4 <- as.data.frame(scale(restrictiveScenario4Df[,-c(1,2)]))

# write_csv(scaleScenario4, "/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Storage Data Frames/scaleScenario4.csv")
```



```{r}
#----DATA COLLATION----#
rainfallDf <- as.data.frame(rainfallRast, xy = TRUE)
colnames(rainfallDf)[3] <- "Total Rainfall (mm)"
rownames(rainfallDf) <- NULL
tempMaxDf <- as.data.frame(tempMaxRast, xy = TRUE)
colnames(tempMaxDf)[3] <- "Max Temp (ºC)"
rownames(tempMaxDf) <- NULL
tempMinDf <- as.data.frame(tempMinRast, xy = TRUE)
colnames(tempMinDf)[3] <- "Min Temp (ºC)"
rownames(tempMinDf) <- NULL
sunDf <- as.data.frame(sunRast, xy = TRUE)
colnames(sunDf)[3] <- "Total Sunlight Hours"
rownames(sunDf) <- NULL
continentalDf <- as.data.frame(continentalRast, xy = TRUE)
colnames(continentalDf)[3] <- "Continentality Index"
rownames(continentalDf) <- NULL
aspectDf <- as.data.frame(aspect, xy = TRUE)
colnames(aspectDf)[3] <- "Aspect (º)"
rownames(aspectDf) <- NULL
slopeDf <- as.data.frame(slope, xy = TRUE)
colnames(slopeDf)[3] <- "Slope (º)"
rownames(slopeDf) <- NULL
soilDrainDf <- as.data.frame(soilDrainRast, xy = TRUE)
colnames(soilDrainDf)[3] <- "Soil Drainage"
rownames(soilDrainDf) <- NULL
scotDEMDf <- as.data.frame(scotlandDEM, xy = TRUE)
colnames(scotDEMDf)[3] <- "Elevation (m)"
rownames(scotDEMDf) <- NULL

#--TREES--#
pineRastDf <- as.data.frame(pineRast, xy = TRUE)
colnames(pineRastDf)[3] <- "Scots Pine"
pineRastDf$`Scots Pine` <- "Scots Pine"
rownames(pineRastDf) <- NULL
oakRastDf <- as.data.frame(oakRast, xy = TRUE)
colnames(oakRastDf)[3] <- "Oak Woodland"
oakRastDf$`Oak Woodland` <- "Oak Woodland"
rownames(oakRastDf) <- NULL
birchRastDf <- as.data.frame(birchRast, xy = TRUE)
colnames(birchRastDf)[3] <- "Birch"
birchRastDf$Birch <- "Birch"
rownames(birchRastDf) <- NULL

# Join all the tree data together
treeDf <- pineRastDf %>%
  full_join(oakRastDf, by = c("x", "y")) %>%
  full_join(birchRastDf, by = c("x", "y"))
# Create NAs where Scots Pine and Birch overlap for Scots Pine
treeDf[!is.na(treeDf$Birch), c("Scots Pine")] <- NA
treeDf[!is.na(treeDf$`Oak Woodland`), c("Scots Pine")] <- NA

# Merge into final table for the training data
finalTable <- treeDf %>%
  merge(rainfallDf, by = c("x", "y")) %>%
  merge(tempMinDf, by = c("x", "y")) %>%
  merge(tempMaxDf, by = c("x", "y")) %>%
  merge(sunDf, by = c("x", "y")) %>%
  merge(continentalDf, by = c("x", "y")) %>%
  merge(aspectDf, by = c("x", "y")) %>%
  merge(slopeDf, by = c("x", "y")) %>%
  merge(soilDrainDf, by = c("x", "y")) %>%
  merge(scotDEMDf, by = c("x", "y"))

# Change the aspect from º to cardinal direction
finalTable$`Aspect (º)` <- ifelse(finalTable$`Aspect (º)` == "(22.5–67.5]", "NE",
       ifelse(finalTable$`Aspect (º)` == "(67.5–112.5]", "E",
              ifelse(finalTable$`Aspect (º)` == "(112.5–157.5]", "SE",
                     ifelse(finalTable$`Aspect (º)` == "(157.5–202.5]", "S",
                            ifelse(finalTable$`Aspect (º)` == "(202.5–247.5]", "SW",
                                   ifelse(finalTable$`Aspect (º)` == "(247.5–292.5]", "W",
                                          ifelse(finalTable$`Aspect (º)` == "(292.5–337.5]", "NW", "N")))))))
finalTable$`Aspect (º)` <- as.factor(finalTable$`Aspect (º)`)
finalTable <- finalTable %>% unite(Tree_Type, `Scots Pine`, `Oak Woodland`, Birch, na.rm = TRUE)
# write_csv(finalTable, "/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Storage Data Frames/finalTable4.csv")


# Test for multicollinearity
fakeTable <- finalTable %>%
  mutate(dummyTreeType = ifelse(Tree_Type == "Birch", 1,
                                ifelse(Tree_Type == "Oak Woodland", 2, 3)))
lm.1 <- lm(dummyTreeType ~ `Total Rainfall (mm)` + `Min Temp (ºC)` + `Max Temp (ºC)` + `Total Sunlight Hours` + `Continentality Index` + `Continentality Index` + `Slope (º)` + `Soil Drainage`, data = fakeTable)
car::vif(lm.1)
# Need to remove Min Temp because of the high collinearity
finalTable <- finalTable %>% select(-`Min Temp (ºC)`)

#----PCA----#
# gathered <- gather(finalTable[,-c(1,2)], x, y, `Total Rainfall (mm)`:`Elevation (m)`)

# ggplot(gathered, aes(x = y, color = Tree_Type, fill = Tree_Type)) +
#   geom_density(alpha = 0.3) +
#   facet_wrap(~x, scales = "free")

# Remove the coordinates from the 
cutTable <- finalTable %>%
  select(-x, -y)
cutTable$`Aspect (º)` <- as.numeric(as.factor(cutTable$`Aspect (º)`))
cutTable$Tree_Type <- as.numeric(as.factor(cutTable$Tree_Type))

# Calculate PCA eigenvalues and the centroids of each group
pcaOutput <- prcomp(as.matrix(cutTable[,-1]), scale = TRUE, center = TRUE)
pcaDf <- as.data.frame(pcaOutput$x)
pcaDf$groups <- finalTable$Tree_Type
centroids <- aggregate(cbind(PC1,PC2) ~ groups, pcaDf, mean)

# Calculate 95% confidence ellipsoids so we can plot these polygons over ggplot
conf.rgn  <- do.call(rbind, lapply(unique(pcaDf$groups), function(t)
  data.frame(groups = as.character(t),
             ellipse(cov(pcaDf[pcaDf$groups == t, 1:2]),
                   centre = as.matrix(centroids[centroids$groups == t, 2:3]),
                   level = 0.95),
             stringsAsFactors = FALSE)))

# Plot PC1 and PC2
ggplot(data = pcaDf, aes(x = PC1, y = PC2, group = as.factor(groups), color = as.factor(groups))) + 
    geom_polygon(data = conf.rgn, aes(fill = groups), alpha = 0.05) +
    geom_point(size = 1, alpha = 0.1) + 
  labs(title = "Principal Component Analysis of Scotland Tree Types: PC1 and PC2") +
  xlab("PC1 (Continentality Index, 35.59%)") +
  ylab("PC2 (Max Temp (ºC), 24.36%)") +
  theme_classic() +
  geom_hline(yintercept = 0, linetype = "dashed", alpha = 0.2) +
  geom_vline(xintercept = 0, linetype = "dashed", alpha = 0.2)

# The plot shows there is quite a lot of overlap in the groups, which is to be expected
# due to these all coming from the same community type and commonly growing together

# Scale the data and then export to be used in the RF model
scaleData <- as.data.frame(scale(cutTable[,-1]))
scaleData$Tree_Type <- finalTable$Tree_Type
scaleData <- scaleData[,c(9,1:8)]

# Looking at the PCA values
factoextra::fviz_cos2(pcaOutput, choice = "var", axes = 1)
factoextra::fviz_cos2(pcaOutput, choice = "var", axes = 2)
factoextra::fviz_cos2(pcaOutput, choice = "var", axes = 3)
factoextra::fviz_cos2(pcaOutput, choice = "var", axes = 4)
factoextra::fviz_cos2(pcaOutput, choice = "var", axes = 5)
factoextra::fviz_cos2(pcaOutput, choice = "var", axes = 6)
factoextra::fviz_cos2(pcaOutput, choice = "var", axes = 7)
factoextra::fviz_cos2(pcaOutput, choice = "var", axes = 8)
summary(pcaOutput)

names(scaleData) <- c("Tree_Type", "Total_Rainfall", "Max_Temp", "Total_Sunlight_Hours", "Continentality_Index", "Aspect", "Slope", "Soil_Drainage", "Elevation")

write_csv(scaleData, "/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Storage Data Frames/scaleData4.csv")
```



```{r}
# #############################################
# # CHECK THIS LATER ON, IT MAY NOT BE NEEDED #
# #############################################
# # Make the table of all the non-training data upon which the models will be deployed
# allDataDf <- rainfallDf %>%
#   merge(tempMinDf, by = c("x", "y"), all.x = TRUE) %>%
#   merge(tempMaxDf, by = c("x", "y"), all.x = TRUE) %>%
#   merge(sunDf, by = c("x", "y"), all.x = TRUE) %>%
#   merge(continentalDf, by = c("x", "y"), all.x = TRUE) %>%
#   merge(aspectDf, by = c("x", "y"), all.x = TRUE) %>%
#   merge(slopeDf, by = c("x", "y"), all.x = TRUE) %>%
#   merge(soilDrainDf, by = c("x", "y"), all.x = TRUE) %>%
#   merge(scotDEMDf, by = c("x", "y"), all.x = TRUE)
# 
# # Which columns have NAs in them
# colnames(allDataDf)[colSums(is.na(allDataDf)) > 0]
# 
# # Fill in with median/mode values
# # Create mode function
# Mode <- function(x) {
#   ux <- unique(x)
#   ux[which.max(tabulate(match(x, ux)))]
# }
# allDataDf$`Aspect (º)`[is.na(allDataDf$`Aspect (º)`)] <- Mode(allDataDf$`Aspect (º)`)
# allDataDf$`Slope (º)`[is.na(allDataDf$`Slope (º)`)] <- median(allDataDf$`Slope (º)`, na.rm = TRUE)
# allDataDf$`Soil Drainage`[is.na(allDataDf$`Soil Drainage`)] <- median(allDataDf$`Soil Drainage`, na.rm = TRUE)
# 
# 
# # Change the aspect from º to cardinal direction
# allDataDf$`Aspect (º)` <- ifelse(allDataDf$`Aspect (º)` == "(22.5–67.5]", "NE",
#        ifelse(allDataDf$`Aspect (º)` == "(67.5–112.5]", "E",
#               ifelse(allDataDf$`Aspect (º)` == "(112.5–157.5]", "SE",
#                      ifelse(allDataDf$`Aspect (º)` == "(157.5–202.5]", "S",
#                             ifelse(allDataDf$`Aspect (º)` == "(202.5–247.5]", "SW",
#                                    ifelse(allDataDf$`Aspect (º)` == "(247.5–292.5]", "W",
#                                           ifelse(allDataDf$`Aspect (º)` == "(292.5–337.5]", "NW", "N")))))))
# allDataDf$`Aspect (º)` <- as.factor(allDataDf$`Aspect (º)`)
# 
# # Scale the data
# allScaleData <- allDataDf
# allScaleData$`Aspect (º)` <- as.numeric(as.factor(allScaleData$`Aspect (º)`))
# allScaleData <- scale(allScaleData[,-c(1,2)]) %>%
#   as.data.frame() %>%
#   cbind(allScaleData[,c(1,2)],.)
# names(allScaleData) <- c("x", "y", "Total_Rainfall", "Min_Temp", "Max_Temp", "Total_Sunlight_Hours", "Continentality_Index", "Aspect", "Slope", "Soil_Drainage", "Elevation")
```

# Send over to scotland.ipynb

# Once that is done, bring it on back

```{r}
# Read in data and then combine into a super data frame
# Random Forest
scenario1 <- read_csv("/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Finished Data/scenario1RFFinished.csv")
scenario2 <- read_csv("/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Finished Data/scenario2RFFinished.csv")
scenario3 <- read_csv("/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Finished Data/scenario3RFFinished.csv")
scenario4 <- read_csv("/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Finished Data/scenario4RFFinished.csv")
restrictiveScenario1Df <- cbind(restrictiveScenario1Df, scenario1[,2]) %>%
  mutate(Predicted_Class = ifelse(Predicted_Class == 0, "Birch",
                                  ifelse(Predicted_Class == 1, "Oak", "Scots Pine")), Scenario = 1)
restrictiveScenario2Df <- cbind(restrictiveScenario2Df, scenario2[,2]) %>%
  mutate(Predicted_Class = ifelse(Predicted_Class == 0, "Birch",
                                  ifelse(Predicted_Class == 1, "Oak", "Scots Pine")), Scenario = 2)
restrictiveScenario3Df <- cbind(restrictiveScenario3Df, scenario3[,2]) %>%
  mutate(Predicted_Class = ifelse(Predicted_Class == 0, "Birch",
                                  ifelse(Predicted_Class == 1, "Oak", "Scots Pine")), Scenario = 3)
restrictiveScenario4Df <- cbind(restrictiveScenario4Df[,-12], scenario4[,2]) %>%
  mutate(Predicted_Class = ifelse(Predicted_Class == 0, "Birch",
                                  ifelse(Predicted_Class == 1, "Oak", "Scots Pine")), Scenario = 4)
allRFScenarios <- rbind(restrictiveScenario1Df, restrictiveScenario2Df, restrictiveScenario3Df, restrictiveScenario4Df)

# XGBoost
scenario1 <- read_csv("/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Finished Data/scenario1XGBFinished.csv")
scenario2 <- read_csv("/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Finished Data/scenario2XGBFinished.csv")
scenario3 <- read_csv("/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Finished Data/scenario3XGBFinished.csv")
scenario4 <- read_csv("/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Finished Data/scenario4XGBFinished.csv")
restrictiveScenario1Df <- cbind(restrictiveScenario1Df %>% select(-Predicted_Class), scenario1[,2]) %>%
  mutate(Predicted_Class = ifelse(.$Predicted_Class == 0, "Birch",
                                  ifelse(.$Predicted_Class == 1, "Oak", "Scots Pine")))
restrictiveScenario2Df <- cbind(restrictiveScenario2Df %>% select(-Predicted_Class), scenario2[,2]) %>%
  mutate(Predicted_Class = ifelse(Predicted_Class == 0, "Birch",
                                  ifelse(Predicted_Class == 1, "Oak", "Scots Pine")))
restrictiveScenario3Df <- cbind(restrictiveScenario3Df %>% select(-Predicted_Class), scenario3[,2]) %>%
  mutate(Predicted_Class = ifelse(Predicted_Class == 0, "Birch",
                                  ifelse(Predicted_Class == 1, "Oak", "Scots Pine")))
restrictiveScenario4Df <- cbind(restrictiveScenario4Df %>% select(-Predicted_Class), scenario4[,2]) %>%
  mutate(Predicted_Class = ifelse(Predicted_Class == 0, "Birch",
                                  ifelse(Predicted_Class == 1, "Oak", "Scots Pine")))
allXGBScenarios <- rbind(restrictiveScenario1Df, restrictiveScenario2Df, restrictiveScenario3Df, restrictiveScenario4Df)

# Multilayer Perceptron
scenario1 <- read_csv("/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Finished Data/scenario1ANNFinished.csv")
scenario2 <- read_csv("/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Finished Data/scenario2ANNFinished.csv")
scenario3 <- read_csv("/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Finished Data/scenario3ANNFinished.csv")
scenario4 <- read_csv("/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Finished Data/scenario4ANNFinished.csv")
restrictiveScenario1Df <- cbind(restrictiveScenario1Df %>% select(-Predicted_Class), scenario1[,2]) %>%
  mutate(Predicted_Class = ifelse(.$Predicted_Class == 0, "Birch",
                                  ifelse(.$Predicted_Class == 1, "Oak", "Scots Pine")))
restrictiveScenario2Df <- cbind(restrictiveScenario2Df %>% select(-Predicted_Class), scenario2[,2]) %>%
  mutate(Predicted_Class = ifelse(Predicted_Class == 0, "Birch",
                                  ifelse(Predicted_Class == 1, "Oak", "Scots Pine")))
restrictiveScenario3Df <- cbind(restrictiveScenario3Df %>% select(-Predicted_Class), scenario3[,2]) %>%
  mutate(Predicted_Class = ifelse(Predicted_Class == 0, "Birch",
                                  ifelse(Predicted_Class == 1, "Oak", "Scots Pine")))
restrictiveScenario4Df <- cbind(restrictiveScenario4Df %>% select(-Predicted_Class), scenario4[,2]) %>%
  mutate(Predicted_Class = ifelse(Predicted_Class == 0, "Birch",
                                  ifelse(Predicted_Class == 1, "Oak", "Scots Pine")))
allANNScenarios <- rbind(restrictiveScenario1Df, restrictiveScenario2Df, restrictiveScenario3Df, restrictiveScenario4Df)

# Add in Model label column
allRFScenarios$Model <- "RF"
allXGBScenarios$Model <- "XGB"
allANNScenarios$Model <- "ANN"

# Bind them all together into a super dataframe
allScenariosDf <- rbind(allRFScenarios, allXGBScenarios, allANNScenarios)

allScenariosDf %>%
  group_by(Predicted_Class, Scenario, Model) %>%
  summarise(n = n()) %>%
  mutate(Name = ifelse(Scenario == 1, "Most Restrictions",
                       ifelse(Scenario == 2, "High restrictions",
                              ifelse(Scenario == 3, "Moderate restrictions", "Least Restrictions")))) %>%
  ggplot(., aes(x = Predicted_Class, y = n, fill = reorder(as.factor(Name), Scenario))) +
  geom_bar(stat = "identity", position = "dodge") +
  theme_classic() +
  labs(x = "Forest Type", y = "Thousands of hectares of potential reforestation") +
  guides(fill = guide_legend(title = "Scenario")) +
  facet_wrap(~ Model) +
  scale_y_continuous(breaks = c(2e05,4e05,6e05,8e05), labels = c(200,400,600,800)) +
    scale_fill_manual(values = c("Most Restrictions" = "#ff99c8",
                               "High restrictions" = "#fcf6bd",
                               "Moderate restrictions" = "#d0f4de",
                               "Least Restrictions" = "#a9def9"))


allScenariosDf %>%
  group_by(Predicted_Class, Scenario, Model) %>%
  summarise(n = n()) %>%
  mutate(Name = ifelse(Scenario == 1, "Most Restrictions",
                       ifelse(Scenario == 2, "High restrictions",
                              ifelse(Scenario == 3, "Moderate restrictions", "Least Restrictions")))) %>%
  ggplot(., aes(x = Predicted_Class, y = n, fill = reorder(as.factor(Name), Scenario))) +
  geom_bar(stat = "identity", position = "dodge") +
  theme_classic() +
  labs(x = "Forest Type", y = "Thousands of hectares of potential reforestation") +
  guides(fill = guide_legend(title = "Scenario")) +
  facet_wrap(~ Model) +
  scale_y_continuous(breaks = c(2e05,4e05,6e05,8e05), labels = c(200,400,600,800)) +
    scale_fill_manual(values = c("Most Restrictions" = "#469d89",
                               "High restrictions" = "#78c6a3",
                               "Moderate restrictions" = "#88d4ab",
                               "Least Restrictions" = "#99e2b4"))

allScenariosDf %>%
  group_by(Scenario, Model) %>%
  summarise(n = n())

# Proportions

allScenariosDf %>%
  group_by(Scenario, Model, Predicted_Class) %>%
  summarise(n = n()) %>%
  mutate(total = sum(n),
         prop = n / total) %>%
  ggplot(., aes(x = Model, y = prop, col = Predicted_Class, fill = Predicted_Class)) +
  geom_bar(stat = "identity") +
  theme_classic() +
  facet_wrap(~Scenario)

allScenariosDf %>%
  group_by(Scenario, Model, Predicted_Class) %>%
  summarise(n = n()) %>%
  mutate(total = sum(n),
         prop = round(n / total, 3)) %>%
  arrange(Scenario)

allScenariosDf %>%
  group_by(Scenario, Model) %>%
  summarise(n = n())
```



```{r}
rfScenario1Rast <- allScenariosDf %>% filter(Model == "RF", Scenario == 1) %>%
  select(x, y, Predicted_Class) %>%
  as_spatraster(.) %>%
  `crs<-`("EPSG:32630")
rfScenario2Rast <- allScenariosDf %>% filter(Model == "RF", Scenario == 2) %>%
  select(x, y, Predicted_Class) %>%
  as_spatraster(.) %>%
  `crs<-`("EPSG:32630")
rfScenario3Rast <- allScenariosDf %>% filter(Model == "RF", Scenario == 3) %>%
  select(x, y, Predicted_Class) %>%
  as_spatraster(.) %>%
  `crs<-`("EPSG:32630")
rfScenario4Rast <- allScenariosDf %>% filter(Model == "RF", Scenario == 4) %>%
  select(x, y, Predicted_Class) %>%
  as_spatraster(.) %>%
  `crs<-`("EPSG:32630")
# XGBoost
xgbScenario1Rast <- allScenariosDf %>% filter(Model == "XGB", Scenario == 1) %>%
  select(x, y, Predicted_Class) %>%
  as_spatraster(.) %>%
  `crs<-`("EPSG:32630")
xgbScenario2Rast <- allScenariosDf %>% filter(Model == "XGB", Scenario == 2) %>%
  select(x, y, Predicted_Class) %>%
  as_spatraster(.) %>%
  `crs<-`("EPSG:32630")
xgbScenario3Rast <- allScenariosDf %>% filter(Model == "XGB", Scenario == 3) %>%
  select(x, y, Predicted_Class) %>%
  as_spatraster(.) %>%
  `crs<-`("EPSG:32630")
xgbScenario4Rast <- allScenariosDf %>% filter(Model == "XGB", Scenario == 4) %>%
  select(x, y, Predicted_Class) %>%
  as_spatraster(.) %>%
  `crs<-`("EPSG:32630")
# Multilayer perceptron
annScenario1Rast <- allScenariosDf %>% filter(Model == "ANN", Scenario == 1) %>%
  select(x, y, Predicted_Class) %>%
  as_spatraster(.) %>%
  `crs<-`("EPSG:32630")
annScenario2Rast <- allScenariosDf %>% filter(Model == "ANN", Scenario == 2) %>%
  select(x, y, Predicted_Class) %>%
  as_spatraster(.) %>%
  `crs<-`("EPSG:32630")
annScenario3Rast <- allScenariosDf %>% filter(Model == "ANN", Scenario == 3) %>%
  select(x, y, Predicted_Class) %>%
  as_spatraster(.) %>%
  `crs<-`("EPSG:32630")
annScenario4Rast <- allScenariosDf %>% filter(Model == "ANN", Scenario == 4) %>%
  select(x, y, Predicted_Class) %>%
  as_spatraster(.) %>%
  `crs<-`("EPSG:32630")

par(mfrow = c(3,4))

# Read in rasters and name them 
folder_path <- "/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Finished Rasters"
tif_files <- list.files(folder_path, pattern = "\\.tif$", full.names = TRUE)
for (file_path in tif_files) {
  file_name <- tools::file_path_sans_ext(basename(file_path))
  raster_object <- rast(file_path)
  assign(file_name, raster_object)
}

# Create a list of rasters and give them the appropriate names
rasterList <- list(rfScenario1Rast,rfScenario2Rast,rfScenario3Rast,rfScenario4Rast,xgbScenario1Rast,xgbScenario2Rast,xgbScenario3Rast,xgbScenario4Rast,annScenario1Rast,annScenario2Rast,annScenario3Rast,annScenario4Rast)

rasterNames <- c("RF Scenario Most", "RF Scenario High", "RF Scenario Moderate", "RF Scenario Least", "XGB Scenario Most", "XGB Scenario High", "XGB Scenario Moderate", "XGB Scenario Least", "MLP Scenario Most", "MLP Scenario High", "MLP Scenario Moderate", "MLP Scenario Least")

# For loop to plot the rasters
colors <- c("#42cafe","#ff5343","#d099ff")
for (i in 1:length(rasterList)) {
  names(rasterList)[i] <- rasterNames[i]  # Name each raster
  plot(rasterList[[i]], main = rasterNames[i], col = colors)  # Plot the raster with its name as the title
  plot(st_geometry(pinewoodShp[2]), add = TRUE, border = "black", lwd = 2, col = NA)  # Overlay the shapefile
}

# Create a pdf image of all the raster together and then export them
pdf("rasters_plot.pdf", width = 14, height = 10)
par(mfrow = c(3, 4))
for (i in 1:length(rasterList)) {
  names(rasterList)[i] <- rasterNames[i]
  plot(rasterList[[i]], main = rasterNames[i], col = colors)
  plot(st_geometry(pinewoodShp[2]), add = TRUE, border = "black", lwd = 2, col = NA)
}
dev.off()



# Function to convert raster to data frame
raster_to_df <- function(raster, name) {
  # Convert raster to points and then to a data.frame
  df <- as.data.frame(raster, xy = TRUE)
  # Rename the third column as "value" for simplicity
  colnames(df) <- c("x", "y", "value")
  df$raster_name <- name  # Add a column to identify the raster
  return(df)
}

# Apply the function to each raster in the list
raster_dfs <- map2(rasterList, rasterNames, raster_to_df)

# Combine all data frames into one
combined_df <- bind_rows(raster_dfs)
combined_df$raster_name <- factor(combined_df$raster_name, levels = c(
  "RF Scenario Most", "RF Scenario High", "RF Scenario Moderate", "RF Scenario Least",
  "XGB Scenario Most", "XGB Scenario High", "XGB Scenario Moderate", "XGB Scenario Least",
  "MLP Scenario Most", "MLP Scenario High", "MLP Scenario Moderate", "MLP Scenario Least"
))

ggplot(combined_df, aes(x = x, y = y, fill = value)) +
  geom_raster() +
  scale_fill_manual(values = c("Birch" = "#42cafe", "Scots Pine" = "#d099ff", "Oak" = "#ff5343")) +
  facet_wrap(~ raster_name) +
  theme_minimal() +
  labs(title = "Raster Plots", fill = "Value", x = "Longitude", y = "Latitude")


allScenariosDf[, -c(1, 2)] %>%
  mutate(across(Total_Rainfall:Elevation, as.numeric)) %>%
  pivot_longer(cols = Total_Rainfall:Elevation, values_to = "value") %>%
  filter(Scenario == 1, Model == "RF", name != "Aspect") %>%
  ggplot(., aes(x = Predicted_Class, y = value, fill = Predicted_Class)) +
  geom_boxplot() +
  theme_classic() +
  facet_wrap(~name, scales = "free_y", ncol = 4)

allScenariosDf[, -c(1, 2)] %>%
  mutate(across(Total_Rainfall:Elevation, as.numeric)) %>%
  pivot_longer(cols = Total_Rainfall:Elevation, values_to = "value") %>%
  filter(Scenario == 1, Model == "ANN", name != "Aspect") %>%
  ggplot(., aes(x = Predicted_Class, y = value, fill = Predicted_Class)) +
  geom_boxplot() +
  theme_classic() +
  facet_wrap(~name, scales = "free_y", ncol = 4)

allScenariosDf[, -c(1, 2)] %>%
  mutate(across(Total_Rainfall:Elevation, as.numeric)) %>%
  pivot_longer(cols = Total_Rainfall:Elevation, values_to = "value") %>%
  filter(Scenario == 1, Model == "XGB", name != "Aspect") %>%
  ggplot(., aes(x = Predicted_Class, y = value, fill = Predicted_Class)) +
  geom_boxplot() +
  theme_classic() +
  facet_wrap(~name, scales = "free_y", ncol = 4)



allScenariosDf[, -c(1, 2)] %>%
  mutate(across(Total_Rainfall:Elevation, as.numeric)) %>%
  pivot_longer(cols = Total_Rainfall:Elevation, values_to = "value") %>%
  filter(name != "Aspect") %>%
  ggplot(., aes(x = Predicted_Class, y = value)) +
  geom_boxplot() +
  theme_classic() +
  facet_wrap(Scenario~name, scales = "free_y")
  
  
```

# Probability Maps

```{r}
# For loop to read in all the probability map that are currently dataframes
models <- c("ANN", "RF", "XGB")
scenarios <- 1:4
probabilityMaps <- list()
for (model in models) {
  for (scenario in scenarios) {
    file_path <- paste0('/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Finished Data/probability', model, scenario, '.csv')
    probabilities <- read_csv(file_path) %>%
      select("0", "1", "2") %>%
      `colnames<-`(c("Birch", "Oak", "Pine"))
    # Filter allScenariosDf to the current scenario and model
    filtered_scenarios <- allScenariosDf %>% filter(Scenario == scenario, Model == model)
    # Merge using x and y
    result <- probabilities %>%
      mutate(RowID = row_number()) %>%
      inner_join(filtered_scenarios %>% mutate(RowID = row_number()), by = "RowID") %>%
      select(x, y, Birch, Oak, Pine) %>%
      mutate(Forest_Type = case_when(
        Birch > Oak & Birch > Pine ~ "Birch",
        Oak > Birch & Oak > Pine ~ "Oak",
        Pine > Birch & Pine > Oak ~ "Pine"),
        Scenario = scenario,
        Model =  model)
    probabilityMaps[[paste0(model, scenario)]] <- result
  }
}


# Create rasters out of the dataframes
result_names <- c(paste0("ANN", 1:4),paste0("RF", 1:4), paste0("XGB", 1:4))
probabilityRasters <- lapply(seq_along(probabilityMaps), function(i) {
  as_spatraster(probabilityMaps[[i]][, c(1, 2, 6)], crs = "epsg:32630") %>% 
    project(templateRaster)
})
# Assign names to the processed results
names(probabilityRasters) <- result_names

# Bind all the rows together
probabilityMapsAll <- bind_rows(probabilityMaps)

# Read in shapefile
Scotland.Shp <- st_read('/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Scotland Shapefile/Scotland_Shapefile/NUTS1_Jan_2018_UGCB_in_the_UK.shp') %>%
  st_transform(crs = crs(templateRaster)) %>%
  filter(nuts118nm == "Scotland") %>%
  st_as_sf()

# Create a bounding box to crop the shapefile too
bounding_box <- st_bbox(c(
  xmin = 260000, # Adjust to exclude Orkney/Shetland
  ymin = 6190000, 
  xmax = 570000, # Adjust to exclude Orkney/Shetland
  ymax = 6500000
), crs = st_crs(Scotland.Shp))
Scotland_cropped <- st_crop(Scotland.Shp, bounding_box)

# # Plot the cropped shapefile
# plot(Scotland_cropped$geometry, col = 'gray88')
# plot(pinewoodShp, add = TRUE, col = NA)
custom_colors <- c("Birch" = "#42cafe", "Pine" = "#d099ff","Oak" = "#ff5343")

# Create a gradient function for each forest type
get_gradient_color <- function(prob, start_color, end_color) {
  scales::col_numeric(palette = colorRampPalette(c(start_color, end_color))(100), 
                      domain = c(0, 1))(prob)
}

# Add a new column for gradient color based on the probabilities
probabilityMapsAll <- probabilityMapsAll %>%
  mutate(
    Fill_Color = case_when(
      Forest_Type == "Birch" ~ get_gradient_color(Birch, "#42cafe", "#b2e9ff"),
      Forest_Type == "Oak" ~ get_gradient_color(Oak, "#ff5343", "#ffb8b1"),
      Forest_Type == "Pine" ~ get_gradient_color(Pine, "#d099ff", "#f0d6ff"),
      TRUE ~ "gray" # Fallback for undefined types
    )
  )

probabilityMapsAll <- probabilityMapsAll %>%
  mutate(
    Scenario = case_when(
      Scenario == 1 ~ "Most",
      Scenario == 2 ~ "High",
      Scenario == 3 ~ "Moderate",
      Scenario == 4 ~ "Least"
    ),
    Scenario = factor(Scenario, levels = c("Most", "High", "Moderate", "Least")), # Set the desired order
    Model = case_when(
      Model == "ANN" ~ "MLP",
      Model == "RF" ~ "Random Forest",
      Model == "XGB" ~ "XGBoost"
    )
  )

# Updated ggplot code
ggplot(probabilityMapsAll) +
  geom_sf(data = Scotland_cropped, col = "black", fill = alpha("gray90", 0.1)) +
  geom_raster(aes(x = x, y = y, fill = Fill_Color)) +
  geom_sf(data = pinewoodShp, col = "black", fill = NA) +
  scale_fill_identity() + # Use identity scale since colors are already calculated
  theme_bw() +
  xlab("Longitude") +
  ylab("Latitude") +
  facet_grid(Model ~ Scenario)


probabilityMapScenario4All <- probabilityMapsAll %>%
  filter(Scenario == 4) %>%
  mutate(Birch_High = ifelse(Birch >= 0.8, 1, 0),
         Oak_High = ifelse(Oak >= 0.8, 1, 0),
         Pine_High = ifelse(Pine >= 0.8, 1, 0)) %>%
  group_by(x, y, Forest_Type) %>%
  summarise(Birch_Count = sum(Birch_High),
            Oak_Count = sum(Oak_High),
            Pine_Count = sum(Pine_High),
            .groups = "drop") %>%
  mutate(Max_High = pmax(Birch_Count, Oak_Count, Pine_Count),
         Forest_Type = case_when(
           Birch_Count == Max_High ~ "Birch",
           Oak_Count == Max_High ~ "Oak",
           Pine_Count == Max_High ~ "Pine",
           TRUE ~ Forest_Type)) %>%
  filter(Max_High > 0) %>%
  mutate(Category = paste0(Forest_Type, Max_High))

custom_colors <- c(
  "Birch1" = "#b2e9ff", "Birch2" = "#86ddfe", "Birch3" = "#42cafe",
  "Pine1" = "#f0d6ff", "Pine2" = "#e0b3ff", "Pine3" = "#d099ff",
  "Oak1" = "#ffb8b1", "Oak2" = "#ff9085", "Oak3" = "#ff5343"
)


ggplot(probabilityMapScenario4All) +
  geom_sf(data = Scotland_cropped, col = "black", fill = alpha("gray99", 0.75)) +
  geom_raster(aes(x = x, y = y, fill = Category)) +
  geom_sf(data = pinewoodShp, col = "black", fill = NA) +
  scale_fill_manual(values = custom_colors) +
  theme_light()

ggplot(probabilityMapScenario4All %>% filter(Max_High > 2)) +
  geom_sf(data = Scotland_cropped, col = "black", fill = alpha("gray90", 0.1)) +
  geom_raster(aes(x = x, y = y, fill = Category)) +
  geom_sf(data = pinewoodShp, col = "black", fill = NA) +
  scale_fill_manual(values = custom_colors,
                    labels = c("Birch", "Oak", "Pine"),
                    name = "Forest Cover Type") +
  theme_light()



highProbabilityRast <- probabilityMapScenario4All %>%
  filter(Max_High > 2) %>%
  select(x,y,Forest_Type) %>%
  as_spatraster(., crs = "epsg:32630") %>%
  project(., templateRaster)


highProbabilityStack <- c(highProbabilityRast,aspect,continentalRast,rainfallRast,scotlandDEM,slope,soilDrainRast,sunRast,tempMinRast,tempMaxRast)

highProbabilityStackDf <- as.data.frame(highProbabilityStack, xy = TRUE) %>%
  drop_na() %>%
  `colnames<-`(c("x", "y", "Forest_Type", "Aspect", "Continental", "Rainfall", "Elevation", "Slope", "SoilDrainage", "Sunlight", "TempMin", "TempMax"))



highProbabilityStackDf[,-c(1,2)] %>%
  pivot_longer(cols = c("Aspect":"TempMax"), values_to = "value")


x <- highProbabilityStackDf[, -c(1, 2)] %>%
  mutate(across(Aspect:TempMax, as.numeric)) %>%
  pivot_longer(cols = Aspect:TempMax, values_to = "value")

x %>%
  filter(name == "Aspect", Forest_Type == "Oak") %>%
  mutate(value = as.factor(ifelse(value == 9, 1, value))) %>%
  ggplot(., aes(x = value, fill = Forest_Type)) +
  geom_bar() +
  theme_classic() +
  scale_x_discrete(name = "Aspect", labels = c("S","SW","W","NW"))

x %>%
  filter(name == "Aspect", Forest_Type != "Oak") %>%
  mutate(value = as.factor(ifelse(value == 9, 1, value))) %>%
  ggplot(., aes(x = value, fill = Forest_Type)) +
  geom_bar(position = "dodge") +
  theme_classic() +
  scale_x_discrete(name = "Aspect", labels = c("N","NE","E","SE","S","SW","W","NW"))

ggplot(x %>% filter(name != "Aspect"), aes(x = Forest_Type, y = value, fill = Forest_Type)) +
  geom_boxplot() +
  theme_classic() +
  facet_wrap(~name, scales = "free_y", ncol = 4)

ggplot(probabilityMapScenario4All %>% filter(Max_High > 2)) +
  geom_sf(data = Scotland_cropped, col = "black", fill = alpha("gray90", 0.1)) +
  geom_raster(aes(x = x, y = y, fill = Category)) +
  geom_sf(data = pinewoodShp, col = "black", fill = NA) +
  scale_fill_manual(values = custom_colors,
                    labels = c("Birch", "Oak", "Pine"),
                    name = "Forest Cover Type") +
  theme_light()




probabilityMapScenario4All %>%
  filter(Category == "Oak3" | Category == "Pine3" | Category == "Birch3")


x %>%
  filter(name == "Continental") %>%
  group_by(Forest_Type) %>%
  summarise(median = median(value),
            mean = mean(value),
            sd = sd(value))

aov.1 <- aov(value ~ Forest_Type, data = x %>% filter(name == "Continental"))
summary(aov.1)
TukeyHSD(aov.1)




aspect <- rast("/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Rasters/aspect.tif")
continentalRast <- rast("/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Rasters/continentalRaster.tif")
pineRast <- rast("/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Rasters/pinewoodRaster.tif")
rainfallRast <- rast("/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Rasters/rainfallRaster.tif")
scotlandDEM <- rast("/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Rasters/scotlandDEM100m.tif")
slope <- rast("/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Rasters/slope.tif")
soilDrainRast <- rast("/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Rasters/soilDrainage.tif")
sunRast <- rast("/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Rasters/sunRaster.tif")
tempMinRast <- rast("/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Rasters/tempMinRaster.tif")
tempMaxRast <- rast("/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Rasters/tempMaxRaster.tif")

plot(continentalRast)

inner_join(scotlandDEM %>% as.data.frame(xy = TRUE),
probabilityMapScenario4All %>% filter(Max_High > 2), by = c("x", "y")) %>%
  ggplot(., aes(x = Forest_Type, y = scotland30mDEM, fill = Forest_Type)) +
  geom_boxplot() +
  theme_classic()

inner_join(continentalDf,
           probabilityMapScenario4All %>% filter(Max_High > 2), by = c("x", "y"))


plot()

```



probabilityMapScenario4All %>%
  filter(Max_High > 2) %>%
  group_by(Forest_Type) %>%
  summarise(n = n()) %>%
  ggplot(., aes(x = Forest_Type, y = n, fill = Forest_Type)) +
  geom_bar(stat = "identity") +
  theme_classic() +
  scale_fill_manual(values = c("Birch" = "blue",
                               "Oak" = "green",
                               "Pine" = "red")) +
  scale_y_continuous(breaks = c(0,0.5e5,1e5,1.5e5),
                     labels = c(0,0.5,1,1.5),
                     name = "Hectares in 0000s")




Scotland.Shp <- st_read('/Users/louisgoodall/Desktop/Portfolio Projects/Data/Scotland/Scotland Shapefile/Scotland_Shapefile/NUTS1_Jan_2018_UGCB_in_the_UK.shp') %>%
  st_transform(crs = crs(templateRaster)) %>%
  filter(nuts118nm == "Scotland") %>%
  st_as_sf()

# Define the bounding box (xmin, ymin, xmax, ymax) in EPSG:32630
bounding_box <- st_bbox(c(
  xmin = 260000, # Adjust to exclude Orkney/Shetland
  ymin = 6190000, 
  xmax = 570000, # Adjust to exclude Orkney/Shetland
  ymax = 6500000
), crs = st_crs(Scotland.Shp))

# Crop the Scotland shapefile
Scotland_cropped <- st_crop(Scotland.Shp, bounding_box)

# Plot the original shapefile and the cropped extent
plot(Scotland.Shp$geometry, col = 'lightblue', main = "Scotland with Bounding Box")
plot(st_as_sfc(bounding_box), add = TRUE, border = 'red', lwd = 2)

# Plot the cropped shapefile
plot(Scotland_cropped$geometry, col = 'gray88', main = "Cropped Scotland (No Orkney/Shetland)")
plot(pinewoodShp, add = TRUE, col = NA)
plot()
```







